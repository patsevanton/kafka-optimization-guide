### Лекция по настройке Kafka

#### Введение
Добро пожаловать на курс по настройке Kafka. Меня зовут Джанини Рави, и я буду вашим преподавателем. Прежде чем мы перейдем к настройке Kafka, давайте кратко рассмотрим, что это такое. Kafka — это распределенная платформа для хранения событий и обработки потоков данных в реальном времени. Она обеспечивает высокую пропускную способность и низкую задержку, что делает её идеальной для обработки потоковых данных.



#### Основные понятия Kafka
1. **Событие (сообщение)** — это запись о произошедшем событии в реальном мире. Например, сообщение в Twitter или данные от датчика IoT.
2. **Продюсеры (Producers)** — приложения, которые публикуют события в Kafka.
3. **Потребители (Consumers)** — приложения, которые подписываются на Топики и читают события.
4. **Брокеры (Brokers)** — серверы, составляющие кластер Kafka. Кластер может состоять от одной до нескольких тысяч машин.
5. **Топики (Topics)** — логические группы или очереди сообщений. Топики делятся на партиции (partitions), что позволяет масштабировать обработку данных.
6. **Репликация** — копии партиций, которые обеспечивают отказоустойчивость и доступность данных.



#### Настройка Kafka: компромиссы

<img width="600" height="551" alt="image" src="https://github.com/user-attachments/assets/22c2c55e-08de-4e4d-ba42-bb582e8ed300" />

Настройка Kafka требует балансировки между несколькими ключевыми показателями:
1. **Задержка vs. Пропускная способность**:
   - Низкая задержка означает быстрое время обработки, но может снизить пропускную способность.
   - Высокая пропускная способность позволяет обрабатывать больше данных, но может увеличить задержку.
2. **Надежность vs. Доступность**:
   - Надежность обеспечивает согласованность данных, но может снизить доступность.
   - Высокая доступность означает, что кластер всегда готов к запросам, но может снизить надежность.

Эти компромиссы определяются настройками Kafka, такими как уровень подтверждения (acks), коэффициент репликации и количество партиций.

---

#### Продюсеры и потребители
1. **Продюсеры**:
   - Уровень подтверждения (`acks`):
     - `acks=0`: подтверждение не требуется (высокая доступность, низкая надежность).
     - `acks=1`: подтверждение от лидера партиции (баланс между надежностью и доступностью).
     - `acks=all`: подтверждение от лидера и всех реплик (высокая надежность, низкая доступность).
2. **Потребители**:
   - Группы потребителей позволяют распределять нагрузку между несколькими потребителями.
   - Ребалансировка группы происходит при добавлении или удалении потребителей.
   - Порядок сообщений гарантируется только при чтении из одной партиции.



#### Теорема оптимизации Kafka

##### Основные понятия
Оптимизация Kafka — это поиск компромиссов между различными параметрами системы. Основные факторы оптимизации:
1. **Задержка** — время обработки одного сообщения.
2. **Пропускная способность** — количество сообщений или объем данных, обрабатываемых за определенный промежуток времени.
3. **Надежность (стабильность)** — устойчивость системы к сбоям и возможность восстановления данных.
4. **Доступность** — вероятность того, что система будет работать и отвечать на запросы.

##### Компромиссы
- **Задержка vs. Пропускная способность**: Низкая задержка часто противоречит высокой пропускной способности.
- **Надежность vs. Доступность**: Высокая доступность (устойчивость к сбоям брокера) может снижать надежность системы.

##### Теорема CAP и PACELC
- **Теорема CAP**: Распределенные системы могут гарантировать только два из трех свойств: согласованность (Consistency), доступность (Availability), устойчивость к разделению (Partition Tolerance). В Kafka выбор обычно делается между согласованностью и доступностью.
- **Теорема PACELC**: Расширение CAP, учитывающее поведение системы при отсутствии разделения. Здесь выбор стоит между оптимизацией задержки (Latency) и согласованности (Consistency).

##### Факторы, влияющие на оптимизацию Kafka
1. **Разделы (Partitions)**:
   - Увеличение числа разделов повышает пропускную способность (параллелизм), но может увеличить задержку из-за обработки метаданных.
2. **Репликация**:
   - Больше реплик → выше надежность, но ниже доступность (из-за необходимости синхронизации).
   - Меньше реплик → выше доступность, но ниже надежность.
3. **Настройки производителя (Producer)**:
   - `acks=all` — высокая надежность (требует подтверждения от всех реплик), но ниже доступность.
   - `acks=0` — высокая доступность (не требует подтверждений), но ниже надежность.
4. **Настройки потребителя (Consumer)**:
   - Частые подтверждения (commits) → высокая согласованность.
   - Увеличение времени ожидания → высокая доступность (допускает временные сбои).

##### Рекомендации
- Для производственных кластеров Kafka рекомендуется:
  - Размещение в трех зонах доступности.
  - Коэффициент репликации = 3.
  - Минимальное число синхронных реплик = 2.
- Параметры по умолчанию:
  - Оптимизированы для низкой задержки (без сжатия, без ожидания подтверждения).
  - Уровень подтверждения `acks=all` для высокой надежности.


#### Задержка в Kafka
Задержка в Kafka состоит из нескольких компонентов:
1. Время создания — обработка записи в Producer.
2. Время публикации — отправка записи от Producer к брокеру.
3. Время фиксации — репликация сообщения на все реплики.
4. Время синхронизации — синхронизация потребителя с журналом.
5. Время выборки — получение записи потребителем.

Оптимизация каждого из этих компонентов позволяет снизить общую задержку.


#### Установка и настройка Kafka
1. **Установка**:
   - Скачайте Kafka с сайта [kafka.apache.org](https://kafka.apache.org/downloads).
   - Распакуйте архив и настройте переменные окружения (`KAFKA_HOME`, `PATH`).
2. **Запуск**:
   - Запустите сервер Zookeeper: `zookeeper-server-start.sh config/zookeeper.properties`.
   - Запустите брокеры Kafka: `kafka-server-start.sh config/server.properties`.
3. **Тестирование**:
   - Создайте топик: `kafka-topics.sh --create --topic test --bootstrap-server localhost:9092`.
   - Запустите Producer и Consumer для проверки работы.


#### Кластер с тремя брокерами
Для реалистичной настройки рекомендуется использовать кластер с тремя брокерами:
1. Настройте уникальные `broker.id`, порты и пути для логов в файлах `server.properties`, `server1.properties`, `server2.properties`.
2. Запустите каждый брокер на своем порту:
   - Брокер 0: `kafka-server-start.sh config/server.properties`.
   - Брокер 1: `kafka-server-start.sh config/server1.properties`.
   - Брокер 2: `kafka-server-start.sh config/server2.properties`.



#### Заключение
Kafka — это мощная платформа для обработки потоковых данных, но её эффективность зависит от правильной настройки. Понимание компромиссов между задержкой, пропускной способностью, надежностью и доступностью поможет вам оптимизировать Kafka для ваших задач. В следующих лекциях мы углубимся в практические аспекты настройки и управления кластером Kafka.
