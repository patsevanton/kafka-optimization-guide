### Лекция по настройке Kafka

#### Введение
Добро пожаловать на курс по настройке Kafka. Прежде чем мы перейдем к настройке Kafka, давайте кратко рассмотрим, что это такое. Kafka — это распределенная платформа для хранения событий и обработки потоков данных в реальном времени. Она обеспечивает высокую пропускную способность и низкую задержку, что делает её идеальной для обработки потоковых данных.



#### Основные понятия Kafka
1. **Событие (сообщение)** — это запись о произошедшем событии в реальном мире. Например, сообщение в Twitter или данные от датчика IoT.
2. **Продюсеры (Producers)** — приложения, которые публикуют события в Kafka.
3. **Потребители (Consumers)** — приложения, которые подписываются на Топики и читают события.
4. **Брокеры (Brokers)** — серверы, составляющие кластер Kafka. Кластер может состоять от одной до нескольких тысяч машин.
5. **Топики (Topics)** — логические группы или очереди сообщений. Топики делятся на партиции (partitions), что позволяет масштабировать обработку данных.
6. **Репликация** — копии партиций, которые обеспечивают отказоустойчивость и доступность данных.



#### Настройка Kafka: компромиссы

<img width="600" height="551" alt="image" src="https://github.com/user-attachments/assets/22c2c55e-08de-4e4d-ba42-bb582e8ed300" />

Настройка Kafka требует балансировки между несколькими ключевыми показателями:
1. **Задержка vs. Пропускная способность**:
   - Низкая задержка означает быстрое время обработки, но может снизить пропускную способность.
   - Высокая пропускная способность позволяет обрабатывать больше данных, но может увеличить задержку.
2. **Надежность vs. Доступность**:
   - Надежность обеспечивает согласованность данных, но может снизить доступность.
   - Высокая доступность означает, что кластер всегда готов к запросам, но может снизить надежность.

Эти компромиссы определяются настройками Kafka, такими как уровень подтверждения (acks), коэффициент репликации и количество партиций.

---

#### Продюсеры и потребители
1. **Продюсеры**:
   - Уровень подтверждения (`acks`):
     - `acks=0`: подтверждение не требуется (высокая доступность, низкая надежность).
     - `acks=1`: подтверждение от лидера партиции (баланс между надежностью и доступностью).
     - `acks=all`: подтверждение от лидера и всех реплик (высокая надежность, низкая доступность).
     - Чем больше подтверждений требуется (acks=all), тем выше надежность, но ниже доступность и выше задержка.
     - Меньшее количество подтверждений (acks=0 или acks=1) повышает доступность и снижает задержку, но уменьшает надежность.
2. **Потребители**:
   - Группы потребителей позволяют распределять нагрузку между несколькими потребителями.
   - Ребалансировка группы происходит при добавлении или удалении потребителей.
   - Порядок сообщений гарантируется только при чтении из одной партиции.



#### Теорема оптимизации Kafka

##### Основные понятия
Оптимизация Kafka — это поиск компромиссов между различными параметрами системы. Основные факторы оптимизации:
1. **Задержка** — время обработки одного сообщения.
2. **Пропускная способность** — количество сообщений или объем данных, обрабатываемых за определенный промежуток времени.
3. **Надежность (стабильность)** — устойчивость системы к сбоям и возможность восстановления данных.
4. **Доступность** — вероятность того, что система будет работать и отвечать на запросы.

##### Компромиссы
- **Задержка vs. Пропускная способность**: Низкая задержка часто противоречит высокой пропускной способности.
- **Надежность vs. Доступность**: Высокая доступность (устойчивость к сбоям брокера) может снижать надежность системы.

##### Теорема CAP и PACELC
- **Теорема CAP**: Распределенные системы могут гарантировать только два из трех свойств: согласованность (Consistency), доступность (Availability), устойчивость к разделению (Partition Tolerance). В Kafka выбор обычно делается между согласованностью и доступностью.
- **Теорема PACELC**: Расширение CAP, учитывающее поведение системы при отсутствии разделения. Здесь выбор стоит между оптимизацией задержки (Latency) и согласованности (Consistency).

##### Факторы, влияющие на оптимизацию Kafka
1. **Разделы (Partitions)**:
   - Увеличение числа разделов повышает пропускную способность (параллелизм), но может увеличить задержку из-за обработки метаданных.
   - Партиции в Kafka являются единицей параллелизма. Чем больше партиций в теме, тем выше пропускная способность кластера Kafka.
   - Оптимальное количество партиций для максимальной производительности — около 10 на тему. Дальнейшее увеличение количества партиций незначительно улучшает пропускную способность, но может увеличить задержку.
2. **Репликация**:
   - Больше реплик → выше надежность, но ниже доступность (из-за необходимости синхронизации).
   - Меньше реплик → выше доступность, но ниже надежность.
   - Для систем, где критична надежность данных, следует выбирать больше реплик (например, 3).
   - Для систем, где важна низкая задержка и высокая пропускная способность, можно использовать меньше реплик (например, 1 или 2), но это повышает риск потери данных.
3. **Настройки производителя (Producer)**:
   - `acks=all` — высокая надежность (требует подтверждения от всех реплик), но ниже доступность.
   - `acks=0` — высокая доступность (не требует подтверждений), но ниже надежность.
4. **Настройки потребителя (Consumer)**:
   - Частые подтверждения (commits) → высокая согласованность.
   - Увеличение времени ожидания → высокая доступность (допускает временные сбои).

##### Рекомендации
- Для производственных кластеров Kafka рекомендуется:
  - Размещение в трех зонах доступности.
  - Коэффициент репликации = 3.
  - Минимальное число синхронных реплик = 2.
- Параметры по умолчанию:
  - Оптимизированы для низкой задержки (без сжатия, без ожидания подтверждения).
  - Уровень подтверждения `acks=all` для высокой надежности.


#### Задержка в Kafka
Задержка в Kafka состоит из нескольких компонентов:
1. Время создания — обработка записи в Producer.
2. Время публикации — отправка записи от Producer к брокеру.
3. Время фиксации — репликация сообщения на все реплики.
4. Время синхронизации — синхронизация потребителя с журналом.
5. Время выборки — получение записи потребителем.

Оптимизация каждого из этих компонентов позволяет снизить общую задержку.

#### Сжатие в Kafka
- Для минимальной задержки: **Gzip**.  
- Для баланса производительности и нагрузки: **Zstd**.  
- Для быстрой обработки с меньшим сжатием: **Lz4**.  
- Если ресурсы CPU ограничены, стоит избегать Gzip и использовать **Snappy** или **Zstd**.

#### Настройка batch size и linger.ms в Kafka Producer
- Для максимальной производительности используйте большой batch.size (например, 25000) и среднюю linger.ms (например, 100).
- Избегайте слишком маленьких значений batch.size и нулевой linger.ms, так как это ухудшает производительность.

#### Заключение
Kafka — это мощная платформа для обработки потоковых данных, но её эффективность зависит от правильной настройки. Понимание компромиссов между задержкой, пропускной способностью, надежностью и доступностью поможет вам оптимизировать Kafka для ваших задач. В следующих лекциях мы углубимся в практические аспекты настройки и управления кластером Kafka.
